<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Aquiles Intermission PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --font-color: white;
            --timer-color: #0ff;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-color);
            color: var(--font-color);
            overflow: hidden;
            transition: background-color 0.5s ease;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 90%;
            max-width: 1200px;
            text-align: center;
            opacity: 1;
            transition: opacity 0.5s ease;
            position: relative; /* Para posicionar telas */
            height: 100%; /* Ocupa a altura disponível */
        }

        .container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* --- Telas Individuais (Intro, Sponsors, Social) --- */
        .screen-phase {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.8s ease-in-out;
            box-sizing: border-box; /* Garante padding incluso na altura/largura */
            padding: 20px; /* Adiciona um padding para o conteúdo */
        }

        .screen-phase.active {
            opacity: 1;
            visibility: visible;
        }

        /* --- Intro / Main Message --- */
        #introScreen {
            gap: 20px;
        }
        #introMessage {
            font-size: 4em;
            font-weight: 800;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
            word-break: break-word;
        }
        #countdownTimer {
            font-family: 'Roboto Mono', monospace;
            font-size: 3em;
            font-weight: 700;
            color: var(--timer-color);
            background-color: rgba(0, 0, 0, 0.4);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* --- Sponsors --- */
        #sponsorScreen {
        }
        #sponsorImage {
            max-width: 95%; /* Ajusta para caber na tela */
            max-height: 90vh; /* Ajusta para caber na altura da tela */
            object-fit: contain;
            display: block;
            margin: auto;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            border-radius: 10px;
            transition: opacity 0.1s ease-in-out;
        }

        /* --- Social Media --- */
        #socialScreen {
            gap: 25px;
        }

        #mainLogo {
            max-width: 250px;
            height: auto;
            object-fit: contain;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 8px rgba(0,0,0,0.5));
        }

        .social-icons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            width: 80%;
            max-width: 600px;
        }
        .social-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .social-item img {
            width: 32px;
            height: 32px;
            filter: brightness(0) invert(1) drop-shadow(0 0 5px rgba(0,0,0,0.5));
        }
        .social-item span {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--font-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .social-item a {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container" id="intermissionContainer">

        <div id="introScreen" class="screen-phase">
            <h1 id="introMessage">Intervalo de Jogo, Voltamos Já!</h1>
            <div id="countdownTimer">02:00</div>
        </div>

        <div id="sponsorScreen" class="screen-phase">
            <img id="sponsorImage" src="" alt="Patrocínio">
        </div>

        <div id="socialScreen" class="screen-phase">
            <img id="mainLogo" src="" alt="Logo Principal">
            <div class="social-icons-grid" id="socialIconsGrid">
                </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // ** SEU FIREBASE CONFIG ESTÁ AQUI (O MESMO QUE VOCÊ JÁ USA) **
        const firebaseConfig = {
            apiKey: "AIzaSyAFp_iujrtqjiTU5yq2yNSBIpwgjQZZyns",
            authDomain: "aquilesplacarpro.firebaseapp.com",
            databaseURL: "https://aquilesplacarpro-default-rtdb.firebaseio.com",
            projectId: "aquilesplacarpro",
            storageBucket: "aquilesplacarpro.firebasestorage.app",
            messagingSenderId: "922321609151",
            appId: "1:922321609151:web:ba51f5b21b322cf0a4c10a"
        };

        const app = firebase.initializeApp(firebaseConfig);
        let database;
        let intervalStateRef;

        let intervalData = {
            intervalDuration: 120,
            currentSeconds: 120, // Tempo restante do cronômetro do intervalo
            running: false,
            currentPhase: 'Intro', // 'Intro', 'Sponsor', 'Social'
            sponsors: [],
            socialMedia: {
                instagram: '', youtube: '', facebook: '', tiktok: '', website: ''
            },
            logoPrincipal: '',
            mainMessage: 'Intervalo de Jogo, Voltamos Já!',
            backgroundColor: '#1a1a1a',
            fontColor: 'white',
            isVisible: true
        };

        let countdownInterval = null; // Timer para o contador regressivo
        let sponsorRotationTimer = null; // Timer para a rotação de patrocínios
        let currentSponsorIndex = 0; // Índice do patrocínio atual

        const introScreen = document.getElementById('introScreen');
        const sponsorScreen = document.getElementById('sponsorScreen');
        const socialScreen = document.getElementById('socialScreen');
        const countdownTimerDisplay = document.getElementById('countdownTimer');
        const introMessageDisplay = document.getElementById('introMessage');
        const sponsorImageDisplay = document.getElementById('sponsorImage');
        const mainLogoDisplay = document.getElementById('mainLogo');
        const socialIconsGrid = document.getElementById('socialIconsGrid');
        const intermissionContainer = document.getElementById('intermissionContainer');

        const socialIcons = {
            instagram: 'https://upload.wikimedia.org/wikipedia/commons/e/e7/Instagram_logo_2016.svg',
            youtube: 'https://upload.wikimedia.org/wikipedia/commons/0/09/YouTube_full-color_icon_%282017%29.svg',
            facebook: 'https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg',
            tiktok: 'https://upload.wikimedia.org/wikipedia/commons/c/c4/TikTok_logo.svg',
            website: 'https://upload.wikimedia.org/wikipedia/commons/0/07/Website_icon_and_symbol.svg'
        };

        document.addEventListener('DOMContentLoaded', initializeApp);

        function initializeApp() {
            database = app.database();
            const urlParams = new URLSearchParams(window.location.search);
            const narratorId = urlParams.get('narratorId');

            if (narratorId) {
                setupFirebaseForNarrator(narratorId);
            } else {
                console.error("ID do Narrador não encontrado na URL. Use ?narratorId=SEU_ID");
                document.body.innerHTML = '<div style="color: red; font-size: 24px; text-align: center; padding: 20px;">ERRO: ID do Narrador não definido na URL.<br>Ex: interval.html?narratorId=seu_id</div>';
            }
        }

        function setupFirebaseForNarrator(narratorId) {
            intervalStateRef = database.ref(`narrators/${narratorId}/intervalState`);

            intervalStateRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const newState = snapshot.val();
                    
                    // Atualiza intervalData com valores do Firebase, usando defaults se não existirem
                    intervalData.intervalDuration = newState.intervalDuration !== undefined ? newState.intervalDuration : 120;
                    intervalData.currentPhase = newState.currentPhase || 'Intro';
                    intervalData.sponsors = newState.sponsors || [];
                    intervalData.socialMedia = newState.socialMedia || { instagram: '', youtube: '', facebook: '', tiktok: '', website: '' };
                    intervalData.logoPrincipal = newState.logoPrincipal || '';
                    intervalData.mainMessage = newState.mainMessage || 'Intervalo de Jogo, Voltamos Já!';
                    intervalData.backgroundColor = newState.backgroundColor || '#1a1a1a';
                    intervalData.fontColor = 'white'; // Mantém a cor da fonte padrão
                    // A cor da fonte agora será diretamente do Firebase para a overlay
                    intervalData.fontColor = newState.fontColor || 'white';
                    intervalData.isVisible = newState.isVisible !== undefined ? newState.isVisible : true;
                    
                    const firebaseCurrentSeconds = newState.currentSeconds !== undefined ? newState.currentSeconds : intervalData.intervalDuration;
                    const firebaseRunning = newState.running !== undefined ? newState.running : false;

                    // Lógica de controle do timer
                    if (firebaseRunning && !countdownInterval) {
                        intervalData.currentSeconds = firebaseCurrentSeconds; // Sincroniza o tempo inicial
                        startCountdown();
                    } else if (!firebaseRunning && countdownInterval) {
                        stopCountdown();
                        intervalData.currentSeconds = firebaseCurrentSeconds; // Sincroniza o tempo parado
                    } else if (!firebaseRunning && !countdownInterval && intervalData.currentSeconds !== firebaseCurrentSeconds) {
                        // Timer parado no Firebase e o tempo foi resetado/ajustado no controlador
                        intervalData.currentSeconds = firebaseCurrentSeconds;
                    }
                    // Se o timer já está rodando localmente e o Firebase continua enviando `running: true`,
                    // não faz nada para não interromper a contagem independente.
                    
                    renderIntermissionScreen(); // Sempre renderiza ao receber atualização
                } else {
                    console.warn(`Nó para narrador '${narratorId}' no estado de intervalo não encontrado no Firebase. Aguardando dados do controlador.`);
                }
            }, (error) => {
                console.error("Erro ao ler dados do Firebase para intervalo:", error);
                document.body.innerHTML = '<div style="color: red; font-size: 24px; text-align: center; padding: 20px;">ERRO DE FIREBASE.<br>Verifique sua configuração ou conexão.</div>';
            });
        }

        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval); // Limpa qualquer timer anterior
            updateCountdownDisplay(); // Atualiza imediatamente

            countdownInterval = setInterval(() => {
                if (intervalData.currentSeconds > 0) {
                    intervalData.currentSeconds--;
                    updateCountdownDisplay();
                    // Não chamamos handlePhaseProgression aqui, pois a fase é ditada pelo Firebase
                } else {
                    stopCountdown();
                    console.log("Contador do intervalo terminou.");
                }
            }, 1000);
        }

        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (sponsorRotationTimer) {
                clearTimeout(sponsorRotationTimer);
                sponsorRotationTimer = null;
            }
            sponsorImageDisplay.style.opacity = '0'; // Esconde a imagem do patrocínio
            currentSponsorIndex = 0; // Reseta o índice
        }

        function updateCountdownDisplay() {
            const minutes = String(Math.floor(intervalData.currentSeconds / 60)).padStart(2, '0');
            const seconds = String(intervalData.currentSeconds % 60).padStart(2, '0');
            countdownTimerDisplay.innerText = `${minutes}:${seconds}`;
        }

        function renderIntermissionScreen() {
            // Aplica estilos base
            document.documentElement.style.setProperty('--bg-color', intervalData.backgroundColor);
            document.documentElement.style.setProperty('--font-color', intervalData.fontColor);

            // Controla a visibilidade geral do container
            if (intervalData.isVisible) {
                intermissionContainer.classList.remove('hidden');
            } else {
                intermissionContainer.classList.add('hidden');
            }

            // Esconde todas as fases primeiro
            introScreen.classList.remove('active');
            sponsorScreen.classList.remove('active');
            socialScreen.classList.remove('active');
            
            // Garante que o timer de rotação de patrocínios esteja parado antes de decidir
            stopSponsorRotation();

            // Exibe a tela correta com base na fase recebida do Firebase
            switch (intervalData.currentPhase) {
                case 'Intro':
                    introScreen.classList.add('active');
                    introMessageDisplay.innerText = intervalData.mainMessage;
                    break;
                case 'Sponsor':
                    sponsorScreen.classList.add('active');
                    startSponsorRotation(); // Inicia a rotação de patrocínios
                    break;
                case 'Social':
                    socialScreen.classList.add('active');
                    renderSocialMedia();
                    break;
                default:
                    introScreen.classList.add('active'); // Padrão se a fase for desconhecida
                    introMessageDisplay.innerText = intervalData.mainMessage;
                    break;
            }
        }

        function startSponsorRotation() {
            if (sponsorRotationTimer) clearTimeout(sponsorRotationTimer); // Limpa timer anterior

            if (intervalData.sponsors && intervalData.sponsors.length > 0) {
                // Esconde a imagem atual rapidamente para transição
                sponsorImageDisplay.style.opacity = '0';
                
                // Muda a imagem após uma pequena pausa para a transição
                setTimeout(() => {
                    const currentSponsor = intervalData.sponsors[currentSponsorIndex];
                    if (currentSponsor && currentSponsor.imageURL) {
                        sponsorImageDisplay.src = currentSponsor.imageURL;
                        sponsorImageDisplay.alt = `Patrocínio ${currentSponsorIndex + 1}`;
                        sponsorImageDisplay.style.opacity = '1'; // Torna visível

                        const duration = currentSponsor.duration || 5; // Padrão 5 segundos
                        
                        currentSponsorIndex = (currentSponsorIndex + 1) % intervalData.sponsors.length; // Próximo patrocínio
                        sponsorRotationTimer = setTimeout(startSponsorRotation, duration * 1000);
                    } else {
                        // Se não houver URL ou patrocínios acabaram, para a rotação
                        console.warn("Nenhum URL de patrocínio válido encontrado ou rotação finalizada.");
                        stopSponsorRotation();
                    }
                }, 100); // Pequeno atraso para a transição de opacidade
            } else {
                console.log("Nenhum patrocínio configurado para rotação.");
                stopSponsorRotation();
            }
        }

        function stopSponsorRotation() {
            if (sponsorRotationTimer) {
                clearTimeout(sponsorRotationTimer);
                sponsorRotationTimer = null;
            }
            sponsorImageDisplay.src = '';
            sponsorImageDisplay.alt = '';
            sponsorImageDisplay.style.opacity = '0';
            currentSponsorIndex = 0; // Reseta o índice para o próximo início
        }

        function renderSocialMedia() {
            socialIconsGrid.innerHTML = ''; // Limpa ícones existentes

            if (intervalData.logoPrincipal) {
                mainLogoDisplay.src = intervalData.logoPrincipal;
                mainLogoDisplay.style.display = 'block';
            } else {
                mainLogoDisplay.src = '';
                mainLogoDisplay.style.display = 'none';
            }

            const { instagram, youtube, facebook, tiktok, website } = intervalData.socialMedia;

            if (instagram) addSocialItem('Instagram', instagram, socialIcons.instagram, `https://www.instagram.com/${instagram.replace('@', '')}/`);
            if (youtube) addSocialItem('YouTube', youtube, socialIcons.youtube, `https://www.youtube.com/${youtube}`); // Link direto para o canal
            if (facebook) addSocialItem('Facebook', facebook, socialIcons.facebook, `https://www.facebook.com/${facebook}`);
            if (tiktok) addSocialItem('TikTok', tiktok, socialIcons.tiktok, `https://www.tiktok.com/@${tiktok.replace('@', '')}`); // Link direto para o perfil
            if (website) addSocialItem('Website', website, socialIcons.website, website.startsWith('http') ? website : `https://${website}`);
        }

        function addSocialItem(name, value, iconUrl, linkUrl) {
            const socialItemDiv = document.createElement('div');
            socialItemDiv.className = 'social-item';
            socialItemDiv.innerHTML = `
                <a href="${linkUrl}" target="_blank" rel="noopener noreferrer">
                    <img src="${iconUrl}" alt="${name} icon">
                    <span>${value}</span>
                </a>
            `;
            socialIconsGrid.appendChild(socialItemDiv);
        }

        // Garante que o estado inicial do cronômetro seja exibido corretamente
        updateCountdownDisplay();
        renderIntermissionScreen(); // Renderiza a tela inicial
    </script>
</body>
</html>
