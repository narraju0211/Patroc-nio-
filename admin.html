<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Denny Martins Marmitaria</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variáveis de Cores */
        :root {
            --primary-color: #e74c3c;
            --secondary-color: #2c3e50;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --light-text-color: #7f8c8d;
            --accent-green: #28a745;
            --accent-blue: #3498db;
            --accent-yellow: #f1c40f;
            --accent-red: #e74c3c;
        }

        /* Estilos básicos */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Container principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 20px;
            background-color: var(--card-background);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        header h1 {
            color: var(--secondary-color);
            font-size: 2.5em;
            margin: 10px 0 0;
            font-weight: 700;
        }

        header p {
            color: var(--light-text-color);
            font-size: 1.2em;
            margin-top: 10px;
        }

        /* Seções do Painel */
        .admin-section {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .admin-section h2 {
            color: var(--secondary-color);
            font-size: 2em;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #c0392b; }
        .btn-success { background-color: var(--accent-green); }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: var(--accent-red); }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-info { background-color: var(--accent-blue); }
        .btn-info:hover { background-color: #2a73a6; }

        /* Tabela de Pedidos */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .orders-table th, .orders-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        .orders-table th {
            background-color: var(--secondary-color);
            color: #fff;
            font-weight: 600;
        }
        .orders-table tr:hover {
            background-color: #f1f1f1;
        }
        .order-actions {
            display: flex;
            gap: 5px;
        }
        .status-select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        /* Itens do Cardápio para Edição */
        .menu-items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .menu-item-edit {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .menu-item-edit span {
            font-weight: 600;
        }
        .menu-item-edit-actions {
            display: flex;
            gap: 5px;
        }

        /* Modal de Confirmação */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%; /* Could be more responsive */
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        /* Notificação Toast */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1001; /* Above modal */
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 1em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        /* Estilo para a pré-visualização da imagem */
        #current-image-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: block; /* Garante que a imagem ocupe sua própria linha */
        }
    </style>
</head>
<body>

    <header>
        <h1>Painel de Controle</h1>
        <p>Gerencie seu negócio Denny Martins Marmitaria</p>
    </header>

    <div class="container">

        <div class="admin-section">
            <h2>Gerenciar Cardápio</h2>
            <form id="menu-form">
                <input type="hidden" id="menu-item-id">
                <div class="form-group">
                    <label for="item-name">Nome do Item</label>
                    <input type="text" id="item-name" required>
                </div>
                <div class="form-group">
                    <label for="item-description">Descrição (opcional)</label>
                    <textarea id="item-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="item-price">Preço (R$)</label>
                    <input type="number" id="item-price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="item-type">Tipo</label>
                    <select id="item-type" required>
                        <option value="marmitas">Marmita</option>
                        <option value="adicionais">Adicional</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="item-image-upload">Upload de Imagem</label>
                    <input type="file" id="item-image-upload" accept="image/*">
                    <img id="current-image-preview" src="" alt="Pré-visualização da imagem atual" style="display:none;">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success" id="btn-save-menu-item">Salvar Item</button>
                    <button type="button" class="btn btn-info" id="btn-clear-form">Limpar Formulário</button>
                </div>
            </form>
            
            <div class="menu-items-list" id="menu-items-list">
                <p id="loading-menu-items">Carregando itens do cardápio...</p>
            </div>
        </div>

        <div class="admin-section">
            <h2>Gerenciar Pedidos</h2>
            <div id="orders-list">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>ID do Pedido</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <p id="loading-orders">Carregando pedidos...</p>
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <!-- Modal de Confirmação -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3>Confirmação</h3>
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button class="btn btn-danger" id="modalConfirmBtn">Sim</button>
                <button class="btn btn-info" id="modalCancelBtn">Não</button>
            </div>
        </div>
    </div>

    <!-- Notificação Toast -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script> <!-- Adicionado Firebase Storage -->

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFp_iujrtqjiTU5yq2yNSBIpwgjQZZyns",
            authDomain: "aquilesplacarpro.firebaseapp.com",
            databaseURL: "https://aquilesplacarpro-default-rtdb.firebaseio.com",
            projectId: "aquilesplacarpro",
            storageBucket: "aquilesplacarpro.firebasestorage.app",
            messagingSenderId: "922321609151",
            appId: "1:922321609151:web:ba51f5b21b322cf0a4c10a"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); // Get a reference to the database service
        const storage = firebase.storage(); // Get a reference to the storage service

        // --- Variáveis de Estado ---
        let menuData = { marmitas: {}, adicionais: {} }; // Usará objetos para mapear por ID do Firebase
        let orders = {}; // Usará objeto para mapear por ID do Firebase

        // --- Elementos do DOM ---
        const menuForm = document.getElementById('menu-form');
        const menuItemsList = document.getElementById('menu-items-list');
        const ordersTableBody = document.getElementById('orders-table-body');
        const btnClearForm = document.getElementById('btn-clear-form');
        const loadingMenuItems = document.getElementById('loading-menu-items');
        const loadingOrders = document.getElementById('loading-orders');
        const itemImageUpload = document.getElementById('item-image-upload');
        const currentImagePreview = document.getElementById('current-image-preview');

        // Modal elements
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        // Toast element
        const toast = document.getElementById('toast');

        // --- Funções Auxiliares ---

        /**
         * Exibe uma mensagem de toast na parte inferior da tela.
         * @param {string} message - A mensagem a ser exibida.
         */
        function showToast(message) {
            toast.innerText = message;
            toast.className = "toast show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        /**
         * Exibe uma modal de confirmação personalizada.
         * @param {string} message - A mensagem a ser exibida na modal.
         * @returns {Promise<boolean>} Uma promessa que resolve para true se confirmado, false se cancelado.
         */
        function showConfirmationModal(message) {
            return new Promise((resolve) => {
                modalMessage.innerText = message;
                confirmationModal.style.display = 'flex'; // Use flex para centralizar

                const confirmHandler = () => {
                    confirmationModal.style.display = 'none';
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(true);
                };

                const cancelHandler = () => {
                    confirmationModal.style.display = 'none';
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', confirmHandler);
                modalCancelBtn.addEventListener('click', cancelHandler);
            });
        }

        // --- Funções de Renderização e Lógica do Admin ---

        /**
         * Renderiza os itens do cardápio na lista de edição.
         * Busca os dados de `menuData` (populados pelo Firebase) e os exibe.
         */
        function renderMenuItems() {
            menuItemsList.innerHTML = ''; // Limpa a lista antes de renderizar
            loadingMenuItems.style.display = 'none'; // Esconde o loading

            let hasItems = false;

            // Renderiza marmitas
            if (menuData.marmitas && Object.keys(menuData.marmitas).length > 0) {
                Object.entries(menuData.marmitas).forEach(([id, item]) => {
                    const itemDiv = createMenuItemDiv(id, item, 'marmitas');
                    menuItemsList.appendChild(itemDiv);
                    hasItems = true;
                });
            }
            
            // Renderiza adicionais
            if (menuData.adicionais && Object.keys(menuData.adicionais).length > 0) {
                Object.entries(menuData.adicionais).forEach(([id, item]) => {
                    const itemDiv = createMenuItemDiv(id, item, 'adicionais');
                    menuItemsList.appendChild(itemDiv);
                    hasItems = true;
                });
            }

            if (!hasItems) {
                menuItemsList.innerHTML = '<p>Nenhum item no cardápio.</p>';
            }
        }

        /**
         * Cria o elemento DIV para um item do cardápio na lista de edição.
         * @param {string} itemId - O ID do item (chave do Firebase).
         * @param {object} itemData - Os dados do item.
         * @param {string} itemType - O tipo do item ('marmitas' ou 'adicionais').
         * @returns {HTMLElement} O elemento DIV criado.
         */
        function createMenuItemDiv(itemId, itemData, itemType) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item-edit';
            itemDiv.innerHTML = `
                <span>${itemData.name} - R$${itemData.price ? itemData.price.toFixed(2).replace('.', ',') : '0,00'}</span>
                <div class="menu-item-edit-actions">
                    <button class="btn btn-info" onclick="editMenuItem('${itemId}', '${itemType}')">Editar</button>
                    <button class="btn btn-danger" onclick="deleteMenuItem('${itemId}', '${itemType}')">Excluir</button>
                </div>
            `;
            return itemDiv;
        }

        /**
         * Renderiza a tabela de pedidos.
         * Busca os dados de `orders` (populados pelo Firebase) e os exibe.
         */
        function renderOrders() {
            ordersTableBody.innerHTML = ''; // Limpa a tabela antes de renderizar
            loadingOrders.style.display = 'none'; // Esconde o loading

            if (orders && Object.keys(orders).length > 0) {
                Object.entries(orders).forEach(([orderId, order]) => {
                    const orderRow = document.createElement('tr');
                    const total = order.total ? order.total.toFixed(2).replace('.', ',') : '0,00';
                    orderRow.innerHTML = `
                        <td>${orderId}</td>
                        <td>${order.clientName}</td>
                        <td>R$ ${total}</td>
                        <td>
                            <select class="status-select" onchange="updateOrderStatus('${orderId}', this.value)">
                                <option value="Pendente" ${order.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                                <option value="Preparando" ${order.status === 'Preparando' ? 'selected' : ''}>Preparando</option>
                                <option value="Saiu para Entrega" ${order.status === 'Saiu para Entrega' ? 'selected' : ''}>Saiu para Entrega</option>
                                <option value="Entregue" ${order.status === 'Entregue' ? 'selected' : ''}>Entregue</option>
                                <option value="Cancelado" ${order.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                            </select>
                        </td>
                        <td class="order-actions">
                            <button class="btn btn-info" onclick="showOrderDetails('${orderId}')">Detalhes</button>
                        </td>
                    `;
                    ordersTableBody.appendChild(orderRow);
                });
            } else {
                ordersTableBody.innerHTML = '<tr><td colspan="5">Nenhum pedido encontrado.</td></tr>';
            }
        }
        
        /**
         * Lida com o envio do formulário de cardápio (adicionar/editar item).
         * Salva ou atualiza o item no Firebase.
         * @param {Event} event - O evento de envio do formulário.
         */
        async function handleMenuFormSubmit(event) {
            event.preventDefault();
            const itemId = document.getElementById('menu-item-id').value;
            const itemName = document.getElementById('item-name').value;
            const itemDescription = document.getElementById('item-description').value;
            const itemPrice = parseFloat(document.getElementById('item-price').value);
            const itemType = document.getElementById('item-type').value;
            const imageFile = itemImageUpload.files[0]; // Pega o arquivo de imagem

            let imageUrl = currentImagePreview.src === window.location.href ? '' : currentImagePreview.src; // Mantém a URL existente se não houver novo upload

            try {
                if (imageFile) {
                    // Se um novo arquivo foi selecionado, faz o upload
                    const storageRef = storage.ref();
                    const imageName = `${Date.now()}-${imageFile.name}`; // Nome único para a imagem
                    const imageRef = storageRef.child(`menu_images/${imageName}`);
                    await imageRef.put(imageFile);
                    imageUrl = await imageRef.getDownloadURL(); // Obtém a URL de download
                    showToast("Imagem enviada com sucesso!");
                }

                const itemData = {
                    name: itemName,
                    description: itemDescription,
                    price: itemPrice,
                    image: imageUrl // Salva a URL da imagem no Realtime Database
                };
                
                if (itemId) {
                    // Atualiza item existente
                    await db.ref(`menu/${itemType}/${itemId}`).update(itemData);
                    showToast(`Item "${itemName}" atualizado com sucesso!`);
                } else {
                    // Adiciona novo item
                    await db.ref(`menu/${itemType}`).push(itemData);
                    showToast(`Item "${itemName}" adicionado com sucesso!`);
                }
                clearForm();
            } catch (error) {
                console.error("Erro ao salvar item no Firebase:", error);
                showToast("Erro ao salvar item. Tente novamente.");
            }
        }
        
        /**
         * Preenche o formulário com os dados de um item para edição.
         * @param {string} itemId - O ID do item (chave do Firebase).
         * @param {string} itemType - O tipo do item ('marmitas' ou 'adicionais').
         */
        function editMenuItem(itemId, itemType) {
            const itemToEdit = menuData[itemType] ? menuData[itemType][itemId] : null;

            if (itemToEdit) {
                document.getElementById('menu-item-id').value = itemId;
                document.getElementById('item-name').value = itemToEdit.name;
                document.getElementById('item-description').value = itemToEdit.description;
                document.getElementById('item-price').value = itemToEdit.price;
                document.getElementById('item-type').value = itemType; // Define o tipo correto
                
                // Exibe a imagem atual
                if (itemToEdit.image) {
                    currentImagePreview.src = itemToEdit.image;
                    currentImagePreview.style.display = 'block';
                } else {
                    currentImagePreview.style.display = 'none';
                    currentImagePreview.src = '';
                }
                itemImageUpload.value = ''; // Limpa o campo de upload para um novo upload
                showToast(`Editando item: ${itemToEdit.name}`);
            } else {
                showToast('Item não encontrado para edição.');
            }
        }

        /**
         * Exclui um item do cardápio do Firebase.
         * @param {string} itemId - O ID do item (chave do Firebase).
         * @param {string} itemType - O tipo do item ('marmitas' ou 'adicionais').
         */
        async function deleteMenuItem(itemId, itemType) {
            const confirmed = await showConfirmationModal("Tem certeza que deseja excluir este item?");
            if (confirmed) {
                try {
                    const itemToDelete = menuData[itemType][itemId];
                    if (itemToDelete && itemToDelete.image) {
                        // Se houver uma imagem associada, tenta excluí-la do Storage
                        const imageRef = storage.refFromURL(itemToDelete.image);
                        await imageRef.delete().catch(error => {
                            console.warn("Erro ao excluir imagem do Storage (pode não existir ou permissão):", error);
                            // Continua mesmo se a exclusão da imagem falhar
                        });
                    }
                    await db.ref(`menu/${itemType}/${itemId}`).remove();
                    showToast("Item excluído com sucesso!");
                } catch (error) {
                    console.error("Erro ao excluir item do Firebase:", error);
                    showToast("Erro ao excluir item. Tente novamente.");
                }
            }
        }

        /**
         * Atualiza o status de um pedido no Firebase.
         * @param {string} orderId - O ID do pedido (chave do Firebase).
         * @param {string} newStatus - O novo status do pedido.
         */
        async function updateOrderStatus(orderId, newStatus) {
            try {
                await db.ref(`orders/${orderId}`).update({ status: newStatus });
                showToast(`Status do pedido ${orderId} atualizado para "${newStatus}"!`);
            } catch (error) {
                console.error("Erro ao atualizar status do pedido no Firebase:", error);
                showToast("Erro ao atualizar status do pedido. Tente novamente.");
            }
        }

        /**
         * Exibe os detalhes de um pedido em uma modal ou console (para simplificar).
         * @param {string} orderId - O ID do pedido.
         */
        function showOrderDetails(orderId) {
            const order = orders[orderId];
            if (order) {
                let details = `Detalhes do Pedido #${orderId}:\n`;
                details += `Cliente: ${order.clientName}\n`;
                details += `Endereço: ${order.clientAddress}\n`;
                details += `Telefone: ${order.clientPhone}\n`;
                details += `Pagamento: ${order.paymentMethod}\n`;
                details += `Total: R$ ${order.total ? order.total.toFixed(2).replace('.', ',') : '0,00'}\n`;
                details += `Status: ${order.status}\n\n`;
                details += 'Itens:\n';
                if (order.items && Array.isArray(order.items)) {
                    order.items.forEach(item => {
                        details += `- ${item.quantity}x ${item.name} (R$ ${item.price ? item.price.toFixed(2).replace('.', ',') : '0,00'})\n`;
                    });
                } else {
                    details += 'Nenhum item detalhado disponível.\n';
                }
                showConfirmationModal(details); // Reutiliza a modal para exibir detalhes
            } else {
                showToast('Detalhes do pedido não encontrados.');
            }
        }

        /**
         * Limpa o formulário de cardápio.
         */
        function clearForm() {
            menuForm.reset();
            document.getElementById('menu-item-id').value = ''; // Limpa o ID oculto
            currentImagePreview.style.display = 'none'; // Esconde a pré-visualização da imagem
            currentImagePreview.src = ''; // Limpa a src da imagem
            showToast("Formulário limpo.");
        }

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            menuForm.addEventListener('submit', handleMenuFormSubmit);
            btnClearForm.addEventListener('click', clearForm);
            
            // Listener para o cardápio (menu)
            db.ref('menu').on('value', (snapshot) => {
                loadingMenuItems.style.display = 'none'; // Esconde a mensagem de carregamento
                const data = snapshot.val();
                menuData = data || { marmitas: {}, adicionais: {} }; // Garante que seja um objeto
                renderMenuItems();
            }, (error) => {
                console.error("Erro ao carregar cardápio do Firebase:", error);
                loadingMenuItems.innerText = 'Erro ao carregar cardápio.';
                showToast('Erro ao carregar cardápio.');
            });

            // Listener para os pedidos
            db.ref('orders').on('value', (snapshot) => {
                loadingOrders.style.display = 'none'; // Esconde a mensagem de carregamento
                const data = snapshot.val();
                orders = data || {}; // Garante que seja um objeto
                renderOrders();
            }, (error) => {
                console.error("Erro ao carregar pedidos do Firebase:", error);
                loadingOrders.innerText = 'Erro ao carregar pedidos.';
                showToast('Erro ao carregar pedidos.');
            });
        });
    </script>
</body>
</html>
