<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Denny Martins Marmitaria</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variáveis de Cores */
        :root {
            --primary-color: #e74c3c;
            --secondary-color: #2c3e50;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --light-text-color: #7f8c8d;
            --accent-green: #28a745;
            --accent-blue: #3498db;
            --accent-yellow: #f1c40f;
            --accent-red: #e74c3c;
        }

        /* Estilos básicos */
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Container principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 20px;
            background-color: var(--card-background);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        header h1 {
            color: var(--secondary-color);
            font-size: 2.5em;
            margin: 10px 0 0;
            font-weight: 700;
        }

        header p {
            color: var(--light-text-color);
            font-size: 1.2em;
            margin-top: 10px;
        }

        .header-info {
            font-size: 0.9em;
            color: var(--light-text-color);
            margin-top: 10px;
        }

        /* Seções do Painel */
        .admin-section {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .admin-section h2 {
            color: var(--secondary-color);
            font-size: 2em;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #c0392b; }
        .btn-success { background-color: var(--accent-green); }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: var(--accent-red); }
        .btn-danger:hover { background-color: #c0392b; }
        .btn-info { background-color: var(--accent-blue); }
        .btn-info:hover { background-color: #2a73a6; }
        .btn-warning { background-color: var(--accent-yellow); color: #333; }
        .btn-warning:hover { background-color: #d4ac07; }


        /* Tabela de Pedidos */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .orders-table th, .orders-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        .orders-table th {
            background-color: var(--secondary-color);
            color: #fff;
            font-weight: 600;
        }
        .orders-table tr:hover {
            background-color: #f1f1f1;
        }
        .order-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap; /* Para quebrar linha em telas menores */
        }
        .status-select {
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        /* Itens do Cardápio para Edição */
        .menu-items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .menu-item-edit {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .menu-item-edit span {
            font-weight: 600;
        }
        .menu-item-edit-actions {
            display: flex;
            gap: 5px;
        }

        /* Modal de Confirmação e Detalhes do Pedido */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%; /* Could be more responsive */
            max-width: 500px; /* Aumentado para detalhes do pedido */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            position: relative; /* Para o botão de fechar */
        }

        .modal-content h3 {
            margin-top: 0;
            color: var(--secondary-color);
        }

        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            cursor: pointer;
            color: #888;
            border: none;
            background: none;
        }
        .modal-order-details {
            text-align: left;
            margin-top: 15px;
            padding: 10px;
            border: 1px dashed #eee;
            background-color: #fcfcfc;
            border-radius: 5px;
        }
        .modal-order-details p {
            margin: 5px 0;
        }
        .modal-order-details strong {
            color: var(--primary-color);
        }
        .modal-order-details ul {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .modal-order-details ul li {
            background-color: #f0f0f0;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 3px;
        }


        /* Notificação Toast */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1001; /* Above modal */
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 1em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        /* Estilos para os color pickers */
        .color-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .color-input-group input[type="color"] {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            cursor: pointer;
        }
        .color-input-group input[type="text"] {
            flex-grow: 1;
        }

        /* Tabs para Pedidos */
        .order-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        .order-tab-button {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-bottom: none;
            padding: 10px 15px;
            cursor: pointer;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            font-weight: 600;
            color: var(--secondary-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .order-tab-button.active {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }
        .order-tab-button:hover:not(.active) {
            background-color: #e0e0e0;
        }
        .order-tab-content {
            display: none; /* Esconde o conteúdo das abas por padrão */
        }
        .order-tab-content.active {
            display: block; /* Mostra o conteúdo da aba ativa */
        }
    </style>
</head>
<body>

    <header>
        <h1>Painel de Controle</h1>
        <p>Gerencie seu negócio Denny Martins Marmitaria</p>
        <p class="header-info" id="current-datetime"></p>
    </header>

    <div class="container">

        <div class="admin-section">
            <h2>Configurações Globais</h2>
            <form id="settings-form">
                <div class="form-group">
                    <label for="marmitaria-name-input">Nome da Marmitaria</label>
                    <input type="text" id="marmitaria-name-input" required>
                </div>
                <div class="form-group">
                    <label for="marmitaria-slogan-input">Slogan da Marmitaria</label>
                    <input type="text" id="marmitaria-slogan-input">
                </div>
                <!-- Logo agora é fixa, removido upload -->
                <div class="form-group">
                    <label>Logo Atual (Fixa)</label>
                    <img src="http://googleusercontent.com/file_content/11" alt="Logo da Marmitaria" style="max-width: 100px; height: auto; border-radius: 50%; border: 2px solid var(--primary-color);">
                    <p style="font-size: 0.8em; color: var(--light-text-color);">A logo é fixa e não pode ser alterada por aqui.</p>
                </div>
                <div class="form-group">
                    <label for="logo-position-select">Posição da Logo no Site</label>
                    <select id="logo-position-select">
                        <option value="left">Esquerda</option>
                        <option value="center">Centro</option>
                        <option value="right">Direita</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Cores para cada Dia da Semana</label>
                    <div id="daily-colors-inputs">
                        <!-- Inputs de cor serão gerados aqui -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="btn-save-settings">Salvar Configurações</button>
                </div>
            </form>
        </div>

        <div class="admin-section">
            <h2>Gerenciar Cardápio</h2>
            <form id="menu-form">
                <input type="hidden" id="menu-item-id">
                <div class="form-group">
                    <label for="item-name">Nome do Item</label>
                    <input type="text" id="item-name" required>
                </div>
                <div class="form-group">
                    <label for="item-description">Descrição (opcional)</label>
                    <textarea id="item-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="item-price">Preço (R$)</label>
                    <input type="number" id="item-price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="item-type">Tipo</label>
                    <select id="item-type" required>
                        <option value="marmitas">Marmita</option>
                        <option value="adicionais">Adicional</option>
                    </select>
                </div>
                <!-- Campo de imagem removido, usará placeholder no cliente -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-success" id="btn-save-menu-item">Salvar Item</button>
                    <button type="button" class="btn btn-info" id="btn-clear-form">Limpar Formulário</button>
                </div>
            </form>
            
            <div class="menu-items-list" id="menu-items-list">
                <p id="loading-menu-items">Carregando itens do cardápio...</p>
            </div>
        </div>

        <div class="admin-section">
            <h2>Gerenciar Pedidos</h2>
            <div class="order-tabs">
                <button class="order-tab-button active" data-tab="new-orders">Novos Pedidos</button>
                <button class="order-tab-button" data-tab="accepted-orders">Pedidos Aceitos</button>
                <button class="order-tab-button" data-tab="completed-orders">Pedidos Encerrados</button>
            </div>

            <div id="new-orders-tab" class="order-tab-content active">
                <h3>Pedidos Pendentes de Confirmação</h3>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>ID do Pedido</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Data/Hora</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="new-orders-table-body">
                        <p id="loading-new-orders">Carregando novos pedidos...</p>
                    </tbody>
                </table>
            </div>

            <div id="accepted-orders-tab" class="order-tab-content">
                <h3>Pedidos Aceitos e em Andamento</h3>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>ID do Pedido</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Data/Hora</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="accepted-orders-table-body">
                        <p id="loading-accepted-orders">Carregando pedidos aceitos...</p>
                    </tbody>
                </table>
            </div>

            <div id="completed-orders-tab" class="order-tab-content">
                <h3>Pedidos Encerrados (Entregues/Recusados)</h3>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>ID do Pedido</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Data/Hora</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="completed-orders-table-body">
                        <p id="loading-completed-orders">Carregando pedidos encerrados...</p>
                    </tbody>
                </table>
            </div>
        </div>
        
    </div>

    <!-- Modal de Confirmação/Detalhes do Pedido -->
    <div id="orderDetailModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal()">&times;</button>
            <h3 id="modalTitle">Detalhes do Pedido</h3>
            <div id="modal-order-details-content" class="modal-order-details">
                <!-- Detalhes do pedido serão carregados aqui -->
            </div>
            <div class="modal-actions">
                <button class="btn btn-success" id="acceptOrderBtn">Aceitar Pedido</button>
                <button class="btn btn-danger" id="rejectOrderBtn">Recusar Pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação Genérica (para exclusão, etc.) -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal()">&times;</button>
            <h3>Confirmação</h3>
            <p id="confirmationModalMessage"></p>
            <div class="modal-actions">
                <button class="btn btn-danger" id="confirmationModalConfirmBtn">Sim</button>
                <button class="btn btn-info" id="confirmationModalCancelBtn">Não</button>
            </div>
        </div>
    </div>

    <!-- Notificação Toast -->
    <div id="toast" class="toast"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAFp_iujrtqjiTU5yq2yNSBIpwgjQZZyns",
            authDomain: "aquilesplacarpro.firebaseapp.com",
            databaseURL: "https://aquilesplacarpro-default-rtdb.firebaseio.com",
            projectId: "aquilesplacarpro",
            storageBucket: "aquilesplacarpro.firebasestorage.app", // Mantido mas não usado para upload
            messagingSenderId: "922321609151",
            appId: "1:922321609151:web:ba51f5b21b322cf0a4c10a"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(); // Get a reference to the database service

        // --- Variáveis de Estado ---
        let menuData = { marmitas: {}, adicionais: {} }; // Usará objetos para mapear por ID do Firebase
        let allOrders = {}; // Armazena todos os pedidos brutos do Firebase
        let globalSettings = {}; // Para armazenar as configurações da marmitaria
        let currentOrderIdInModal = null; // Para saber qual pedido está na modal de detalhes

        // --- Elementos do DOM ---
        const menuForm = document.getElementById('menu-form');
        const menuItemsList = document.getElementById('menu-items-list');
        const btnClearForm = document.getElementById('btn-clear-form');

        // Settings form elements
        const settingsForm = document.getElementById('settings-form');
        const marmitariaNameInput = document.getElementById('marmitaria-name-input');
        const marmitariaSloganInput = document.getElementById('marmitaria-slogan-input');
        const logoPositionSelect = document.getElementById('logo-position-select');
        const dailyColorsInputsDiv = document.getElementById('daily-colors-inputs');
        const currentDateTime = document.getElementById('current-datetime');

        // Order tab elements
        const orderTabButtons = document.querySelectorAll('.order-tab-button');
        const newOrdersTab = document.getElementById('new-orders-tab');
        const acceptedOrdersTab = document.getElementById('accepted-orders-tab');
        const completedOrdersTab = document.getElementById('completed-orders-tab');

        // Order table bodies
        const newOrdersTableBody = document.getElementById('new-orders-table-body');
        const acceptedOrdersTableBody = document.getElementById('accepted-orders-table-body');
        const completedOrdersTableBody = document.getElementById('completed-orders-table-body');

        // Loading messages for orders
        const loadingNewOrders = document.getElementById('loading-new-orders');
        const loadingAcceptedOrders = document.getElementById('loading-accepted-orders');
        const loadingCompletedOrders = document.getElementById('loading-completed-orders');

        // Order Detail Modal elements
        const orderDetailModal = document.getElementById('orderDetailModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalOrderDetailsContent = document.getElementById('modal-order-details-content');
        const acceptOrderBtn = document.getElementById('acceptOrderBtn');
        const rejectOrderBtn = document.getElementById('rejectOrderBtn');

        // Generic Confirmation Modal elements
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationModalMessage = document.getElementById('confirmationModalMessage');
        const confirmationModalConfirmBtn = document.getElementById('confirmationModalConfirmBtn');
        const confirmationModalCancelBtn = document.getElementById('confirmationModalCancelBtn');

        // Toast element
        const toast = document.getElementById('toast');

        // Days of the week for daily colors
        const daysOfWeekNames = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
        const daysOfWeekKeys = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // --- Funções Auxiliares ---

        /**
         * Exibe uma mensagem de toast na parte inferior da tela.
         * @param {string} message - A mensagem a ser exibida.
         */
        function showToast(message) {
            toast.innerText = message;
            toast.className = "toast show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        /**
         * Exibe uma modal de confirmação personalizada.
         * @param {string} message - A mensagem a ser exibida na modal.
         * @returns {Promise<boolean>} Uma promessa que resolve para true se confirmado, false se cancelado.
         */
        function showConfirmationModal(message) {
            return new Promise((resolve) => {
                confirmationModalMessage.innerText = message;
                confirmationModal.style.display = 'flex'; // Use flex para centralizar

                const confirmHandler = () => {
                    closeModal(); // Fecha a modal genérica
                    confirmationModalConfirmBtn.removeEventListener('click', confirmHandler);
                    confirmationModalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(true);
                };

                const cancelHandler = () => {
                    closeModal(); // Fecha a modal genérica
                    confirmationModalConfirmBtn.removeEventListener('click', confirmHandler);
                    confirmationModalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                confirmationModalConfirmBtn.addEventListener('click', confirmHandler);
                confirmationModalCancelBtn.addEventListener('click', cancelHandler);
            });
        }

        /**
         * Fecha qualquer modal aberta.
         */
        function closeModal() {
            orderDetailModal.style.display = 'none';
            confirmationModal.style.display = 'none';
            currentOrderIdInModal = null; // Limpa o ID do pedido na modal
        }

        /**
         * Atualiza a data e hora no cabeçalho.
         */
        function updateDateTime() {
            const now = new Date();
            const months = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];

            const dayOfWeek = daysOfWeekNames[now.getDay()];
            const dayOfMonth = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');

            currentDateTime.innerText = `Bom dia! Hoje é ${dayOfWeek}, ${dayOfMonth} de ${month} de ${year} às ${hours}:${minutes}.`;
        }

        // --- Funções de Renderização e Lógica do Admin ---

        /**
         * Renderiza os inputs de cor para cada dia da semana.
         * Preenche com os valores existentes nas configurações globais.
         */
        function renderDailyColorsInputs() {
            dailyColorsInputsDiv.innerHTML = '';
            daysOfWeekKeys.forEach((dayKey, index) => {
                const dayName = daysOfWeekNames[index];
                const currentColor = globalSettings.dailyColors ? (globalSettings.dailyColors[dayKey] || '#e74c3c') : '#e74c3c';

                const div = document.createElement('div');
                div.className = 'color-input-group';
                div.innerHTML = `
                    <label>${dayName}:</label>
                    <input type="color" id="color-${dayKey}" value="${currentColor}">
                    <input type="text" id="hex-${dayKey}" value="${currentColor}" pattern="#[0-9a-fA-F]{6}" title="Formato Hex: #RRGGBB">
                `;
                dailyColorsInputsDiv.appendChild(div);

                // Sincroniza color picker com text input
                div.querySelector(`#color-${dayKey}`).addEventListener('input', (e) => {
                    div.querySelector(`#hex-${dayKey}`).value = e.target.value;
                });
                div.querySelector(`#hex-${dayKey}`).addEventListener('input', (e) => {
                    const hexValue = e.target.value;
                    if (/^#[0-9a-fA-F]{6}$/.test(hexValue)) {
                        div.querySelector(`#color-${dayKey}`).value = hexValue;
                    }
                });
            });
        }

        /**
         * Preenche o formulário de configurações globais com os dados do Firebase.
         */
        function fillSettingsForm() {
            if (globalSettings.name) marmitariaNameInput.value = globalSettings.name;
            if (globalSettings.slogan) marmitariaSloganInput.value = globalSettings.slogan;
            if (globalSettings.logoPosition) logoPositionSelect.value = globalSettings.logoPosition;
            renderDailyColorsInputs(); // Renderiza os inputs de cor com os valores atuais
        }

        /**
         * Lida com o envio do formulário de configurações globais.
         * Salva as configurações no Firebase.
         * @param {Event} event - O evento de envio do formulário.
         */
        async function handleSettingsFormSubmit(event) {
            event.preventDefault();

            const newSettings = {
                name: marmitariaNameInput.value,
                slogan: marmitariaSloganInput.value,
                logoPosition: logoPositionSelect.value,
                dailyColors: {}
            };

            // Coleta as cores diárias
            daysOfWeekKeys.forEach(dayKey => {
                const hexInput = document.getElementById(`hex-${dayKey}`);
                if (hexInput && /^#[0-9a-fA-F]{6}$/.test(hexInput.value)) {
                    newSettings.dailyColors[dayKey] = hexInput.value;
                }
            });

            // Logo agora é fixa, não há upload
            newSettings.logoUrl = 'http://googleusercontent.com/file_content/11'; // URL fixa da logo

            try {
                await db.ref('settings').set(newSettings);
                showToast("Configurações salvas com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar configurações no Firebase:", error);
                showToast("Erro ao salvar configurações. Tente novamente. Verifique o console para detalhes.");
            }
        }

        /**
         * Renderiza os itens do cardápio na lista de edição.
         * Busca os dados de `menuData` (populados pelo Firebase) e os exibe.
         */
        function renderMenuItems() {
            menuItemsList.innerHTML = ''; // Limpa a lista antes de renderizar
            loadingMenuItems.style.display = 'none'; // Esconde o loading

            let hasItems = false;

            // Renderiza marmitas
            if (menuData.marmitas && Object.keys(menuData.marmitas).length > 0) {
                Object.entries(menuData.marmitas).forEach(([id, item]) => {
                    const itemDiv = createMenuItemDiv(id, item, 'marmitas');
                    menuItemsList.appendChild(itemDiv);
                    hasItems = true;
                });
            }
            
            // Renderiza adicionais
            if (menuData.adicionais && Object.keys(menuData.adicionais).length > 0) {
                Object.entries(menuData.adicionais).forEach(([id, item]) => {
                    const itemDiv = createMenuItemDiv(id, item, 'adicionais');
                    menuItemsList.appendChild(itemDiv);
                    hasItems = true;
                });
            }

            if (!hasItems) {
                menuItemsList.innerHTML = '<p>Nenhum item no cardápio.</p>';
            }
        }

        /**
         * Cria o elemento DIV para um item do cardápio na lista de edição.
         * @param {string} itemId - O ID do item (chave do Firebase).
         * @param {object} itemData - Os dados do item.
         * @param {string} itemType - O tipo do item ('marmitas' ou 'adicionais').
         * @returns {HTMLElement} O elemento DIV criado.
         */
        function createMenuItemDiv(itemId, itemData, itemType) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item-edit';
            itemDiv.innerHTML = `
                <span>${itemData.name} - R$${itemData.price ? itemData.price.toFixed(2).replace('.', ',') : '0,00'}</span>
                <div class="menu-item-edit-actions">
                    <button class="btn btn-info" onclick="editMenuItem('${itemId}', '${itemType}')">Editar</button>
                    <button class="btn btn-danger" onclick="deleteMenuItem('${itemId}', '${itemType}')">Excluir</button>
                </div>
            `;
            return itemDiv;
        }

        /**
         * Renderiza a tabela de pedidos em suas respectivas abas.
         */
        function renderOrders() {
            newOrdersTableBody.innerHTML = '';
            acceptedOrdersTableBody.innerHTML = '';
            completedOrdersTableBody.innerHTML = '';

            loadingNewOrders.style.display = 'none';
            loadingAcceptedOrders.style.display = 'none';
            loadingCompletedOrders.style.display = 'none';

            let hasNewOrders = false;
            let hasAcceptedOrders = false;
            let hasCompletedOrders = false;

            // Converte o objeto de pedidos em um array para poder ordenar
            const sortedOrders = Object.entries(allOrders).sort(([, a], [, b]) => {
                // Ordena do mais novo para o mais antigo
                return (b.timestamp || 0) - (a.timestamp || 0);
            });

            sortedOrders.forEach(([orderId, order]) => {
                const orderDate = order.timestamp ? new Date(order.timestamp).toLocaleString('pt-BR') : 'N/A';
                const total = order.total ? order.total.toFixed(2).replace('.', ',') : '0,00';
                
                const orderRow = document.createElement('tr');
                orderRow.innerHTML = `
                    <td>${orderId}</td>
                    <td>${order.clientName}</td>
                    <td>R$ ${total}</td>
                    <td>${order.status}</td>
                    <td>${orderDate}</td>
                    <td class="order-actions">
                        <!-- Ações específicas para cada aba/status -->
                    </td>
                `;

                const actionsCell = orderRow.querySelector('.order-actions');

                if (order.status === 'Pendente') {
                    orderRow.cells[3].innerText = 'Pendente'; // Garante que o status na coluna seja "Pendente"
                    actionsCell.innerHTML = `
                        <button class="btn btn-info" onclick="showOrderDetails('${orderId}')">Ver Detalhes</button>
                    `;
                    newOrdersTableBody.appendChild(orderRow);
                    hasNewOrders = true;
                } else if (['Aceito', 'Preparando', 'Saiu para Entrega'].includes(order.status)) {
                    actionsCell.innerHTML = `
                        <select class="status-select" onchange="updateOrderStatus('${orderId}', this.value)">
                            <option value="Aceito" ${order.status === 'Aceito' ? 'selected' : ''}>Aceito</option>
                            <option value="Preparando" ${order.status === 'Preparando' ? 'selected' : ''}>Preparando</option>
                            <option value="Saiu para Entrega" ${order.status === 'Saiu para Entrega' ? 'selected' : ''}>Saiu para Entrega</option>
                        </select>
                        <button class="btn btn-warning" onclick="completeOrder('${orderId}')">Encerrar Pedido</button>
                    `;
                    acceptedOrdersTableBody.appendChild(orderRow);
                    hasAcceptedOrders = true;
                } else if (['Entregue', 'Cancelado', 'Recusado', 'Encerrado'].includes(order.status)) {
                    actionsCell.innerHTML = `
                        <button class="btn btn-info" onclick="showOrderDetails('${orderId}')">Ver Detalhes</button>
                    `;
                    completedOrdersTableBody.appendChild(orderRow);
                    hasCompletedOrders = true;
                }
            });

            if (!hasNewOrders) {
                newOrdersTableBody.innerHTML = '<tr><td colspan="5">Nenhum novo pedido pendente.</td></tr>';
            }
            if (!hasAcceptedOrders) {
                acceptedOrdersTableBody.innerHTML = '<tr><td colspan="6">Nenhum pedido aceito ou em andamento.</td></tr>';
            }
            if (!hasCompletedOrders) {
                completedOrdersTableBody.innerHTML = '<tr><td colspan="6">Nenhum pedido encerrado.</td></tr>';
            }
        }

        /**
         * Lida com a troca de abas de pedidos.
         * @param {string} tabId - O ID da aba a ser ativada ('new-orders', 'accepted-orders', 'completed-orders').
         */
        function switchOrderTab(tabId) {
            // Remove 'active' de todos os botões e conteúdos
            orderTabButtons.forEach(button => button.classList.remove('active'));
            document.querySelectorAll('.order-tab-content').forEach(content => content.classList.remove('active'));

            // Adiciona 'active' ao botão e conteúdo corretos
            document.querySelector(`.order-tab-button[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }
        
        /**
         * Lida com o envio do formulário de cardápio (adicionar/editar item).
         * Salva ou atualiza o item no Firebase.
         * @param {Event} event - O evento de envio do formulário.
         */
        async function handleMenuFormSubmit(event) {
            event.preventDefault();
            const itemId = document.getElementById('menu-item-id').value;
            const itemName = document.getElementById('item-name').value;
            const itemDescription = document.getElementById('item-description').value;
            const itemPrice = parseFloat(document.getElementById('item-price').value);
            const itemType = document.getElementById('item-type').value;

            const itemData = {
                // Se for um novo item, gera um ID; se for edição, usa o ID existente
                id: itemId || db.ref(`menu/${itemType}`).push().key,
                name: itemName,
                description: itemDescription,
                price: itemPrice,
                image: '' // Imagem agora é fixa/placeholder no cliente, não é editável aqui
            };
            
            try {
                if (itemId) {
                    // Atualiza item existente
                    await db.ref(`menu/${itemType}/${itemId}`).update(itemData);
                    showToast(`Item "${itemName}" atualizado com sucesso!`);
                } else {
                    // Adiciona novo item
                    await db.ref(`menu/${itemType}/${itemData.id}`).set(itemData); // Usa o ID gerado
                    showToast(`Item "${itemName}" adicionado com sucesso!`);
                }
                clearForm();
            } catch (error) {
                console.error("Erro ao salvar item no Firebase:", error);
                showToast("Erro ao salvar item. Tente novamente. Verifique o console para detalhes.");
            }
        }
        
        /**
         * Preenche o formulário com os dados de um item para edição.
         * @param {string} itemId - O ID do item (chave do Firebase).
         * @param {string} itemType - O tipo do item ('marmitas' ou 'adicionais').
         */
        function editMenuItem(itemId, itemType) {
            const itemToEdit = menuData[itemType] ? menuData[itemType][itemId] : null;

            if (itemToEdit) {
                document.getElementById('menu-item-id').value = itemId;
                document.getElementById('item-name').value = itemToEdit.name;
                document.getElementById('item-description').value = itemToEdit.description;
                document.getElementById('item-price').value = itemToEdit.price;
                document.getElementById('item-type').value = itemType; // Define o tipo correto
                showToast(`Editando item: ${itemToEdit.name}`);
            } else {
                showToast('Item não encontrado para edição.');
            }
        }

        /**
         * Exclui um item do cardápio do Firebase.
         * @param {string} itemId - O ID do item (chave do Firebase).
         * @param {string} itemType - O tipo do item ('marmitas' ou 'adicionais').
         */
        async function deleteMenuItem(itemId, itemType) {
            const confirmed = await showConfirmationModal("Tem certeza que deseja excluir este item?");
            if (confirmed) {
                try {
                    await db.ref(`menu/${itemType}/${itemId}`).remove();
                    showToast("Item excluído com sucesso!");
                } catch (error) {
                    console.error("Erro ao excluir item do Firebase:", error);
                    showToast("Erro ao excluir item. Tente novamente. Verifique o console para detalhes.");
                }
            }
        }

        /**
         * Exibe os detalhes de um pedido em uma modal e permite aceitar/recusar.
         * @param {string} orderId - O ID do pedido.
         */
        function showOrderDetails(orderId) {
            const order = allOrders[orderId];
            if (!order) {
                showToast('Pedido não encontrado.');
                return;
            }

            currentOrderIdInModal = orderId; // Armazena o ID do pedido atual na modal

            modalTitle.innerText = `Detalhes do Pedido #${orderId}`;
            let detailsHtml = `
                <p><strong>Cliente:</strong> ${order.clientName}</p>
                <p><strong>Endereço:</strong> ${order.clientAddress}</p>
                <p><strong>Telefone:</strong> ${order.clientPhone}</p>
                <p><strong>Pagamento:</strong> ${order.paymentMethod}</p>
                <p><strong>Total:</strong> R$ ${order.total ? order.total.toFixed(2).replace('.', ',') : '0,00'}</p>
                <p><strong>Status:</strong> ${order.status}</p>
                <p><strong>Data/Hora:</strong> ${order.timestamp ? new Date(order.timestamp).toLocaleString('pt-BR') : 'N/A'}</p>
                <h4>Itens do Pedido:</h4>
                <ul>
            `;
            if (order.items && Array.isArray(order.items)) {
                order.items.forEach(item => {
                    detailsHtml += `<li>${item.quantity}x ${item.name} (R$ ${item.price ? item.price.toFixed(2).replace('.', ',') : '0,00'})</li>`;
                });
            } else {
                detailsHtml += '<li>Nenhum item detalhado disponível.</li>';
            }
            detailsHtml += `</ul>`;
            modalOrderDetailsContent.innerHTML = detailsHtml;

            // Mostra/esconde botões de aceitar/recusar dependendo do status
            if (order.status === 'Pendente') {
                acceptOrderBtn.style.display = 'inline-block';
                rejectOrderBtn.style.display = 'inline-block';
            } else {
                acceptOrderBtn.style.display = 'none';
                rejectOrderBtn.style.display = 'none';
            }

            orderDetailModal.style.display = 'flex'; // Exibe a modal de detalhes
        }

        /**
         * Aceita um pedido, mudando seu status para 'Aceito'.
         */
        async function acceptOrder() {
            if (!currentOrderIdInModal) return;
            const confirmed = await showConfirmationModal(`Tem certeza que deseja aceitar o pedido #${currentOrderIdInModal}?`);
            if (confirmed) {
                try {
                    await db.ref(`orders/${currentOrderIdInModal}`).update({ status: 'Aceito' });
                    showToast(`Pedido #${currentOrderIdInModal} aceito!`);
                    closeModal(); // Fecha a modal após a ação
                } catch (error) {
                    console.error("Erro ao aceitar pedido:", error);
                    showToast("Erro ao aceitar pedido. Tente novamente.");
                }
            }
        }

        /**
         * Recusa um pedido, mudando seu status para 'Recusado'.
         */
        async function rejectOrder() {
            if (!currentOrderIdInModal) return;
            const confirmed = await showConfirmationModal(`Tem certeza que deseja recusar o pedido #${currentOrderIdInModal}?`);
            if (confirmed) {
                try {
                    await db.ref(`orders/${currentOrderIdInModal}`).update({ status: 'Recusado' });
                    showToast(`Pedido #${currentOrderIdInModal} recusado!`);
                    closeModal(); // Fecha a modal após a ação
                } catch (error) {
                    console.error("Erro ao recusar pedido:", error);
                    showToast("Erro ao recusar pedido. Tente novamente.");
                }
            }
        }

        /**
         * Atualiza o status de um pedido no Firebase (usado para pedidos aceitos).
         * @param {string} orderId - O ID do pedido (chave do Firebase).
         * @param {string} newStatus - O novo status do pedido.
         */
        async function updateOrderStatus(orderId, newStatus) {
            try {
                await db.ref(`orders/${orderId}`).update({ status: newStatus });
                showToast(`Status do pedido ${orderId} atualizado para "${newStatus}"!`);
            } catch (error) {
                console.error("Erro ao atualizar status do pedido no Firebase:", error);
                showToast("Erro ao atualizar status do pedido. Tente novamente. Verifique o console para detalhes.");
            }
        }

        /**
         * Encerra um pedido, mudando seu status para 'Encerrado'.
         * @param {string} orderId - O ID do pedido.
         */
        async function completeOrder(orderId) {
            const confirmed = await showConfirmationModal(`Tem certeza que deseja encerrar o pedido #${orderId}? Isso o moverá para a lista de pedidos encerrados.`);
            if (confirmed) {
                try {
                    await db.ref(`orders/${orderId}`).update({ status: 'Encerrado' });
                    showToast(`Pedido #${orderId} encerrado!`);
                } catch (error) {
                    console.error("Erro ao encerrar pedido:", error);
                    showToast("Erro ao encerrar pedido. Tente novamente.");
                }
            }
        }

        /**
         * Limpa o formulário de cardápio.
         */
        function clearForm() {
            menuForm.reset();
            document.getElementById('menu-item-id').value = ''; // Limpa o ID oculto
            showToast("Formulário limpo.");
        }

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            menuForm.addEventListener('submit', handleMenuFormSubmit);
            btnClearForm.addEventListener('click', clearForm);
            settingsForm.addEventListener('submit', handleSettingsFormSubmit);

            // Adiciona listeners para os botões da modal de detalhes do pedido
            acceptOrderBtn.addEventListener('click', acceptOrder);
            rejectOrderBtn.addEventListener('click', rejectOrder);
            // Adiciona listener para fechar a modal clicando no X
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', closeModal);
            });
            // Adiciona listener para fechar a modal clicando fora dela
            window.addEventListener('click', (event) => {
                if (event.target === orderDetailModal || event.target === confirmationModal) {
                    closeModal();
                }
            });

            // Adiciona listeners para as abas de pedidos
            orderTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    switchOrderTab(tabId);
                });
            });
            // Ativa a primeira aba por padrão
            switchOrderTab('new-orders');


            // Listener para as configurações globais
            db.ref('settings').on('value', (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    globalSettings = settings;
                    fillSettingsForm(); // Preenche o formulário de settings
                } else {
                    console.warn("Nenhuma configuração global encontrada no Firebase. Usando padrões.");
                    globalSettings = {}; // Garante que o objeto esteja vazio se não houver settings
                    fillSettingsForm(); // Preenche com valores padrão
                }
            }, (error) => {
                console.error("Erro ao carregar configurações globais:", error);
                showToast('Erro ao carregar configurações.');
            });
            
            // Listener para o cardápio (menu)
            db.ref('menu').on('value', (snapshot) => {
                loadingMenuItems.style.display = 'none'; // Esconde a mensagem de carregamento
                const data = snapshot.val();
                menuData = data || { marmitas: {}, adicionais: {} }; // Garante que seja um objeto
                renderMenuItems();
            }, (error) => {
                console.error("Erro ao carregar cardápio do Firebase:", error);
                loadingMenuItems.innerText = 'Erro ao carregar cardápio.';
                showToast('Erro ao carregar cardápio.');
            });

            // Listener para os pedidos
            db.ref('orders').on('value', (snapshot) => {
                loadingNewOrders.style.display = 'none';
                loadingAcceptedOrders.style.display = 'none';
                loadingCompletedOrders.style.display = 'none';
                const data = snapshot.val();
                allOrders = data || {}; // Armazena todos os pedidos
                renderOrders(); // Renderiza todos os pedidos nas abas corretas
            }, (error) => {
                console.error("Erro ao carregar pedidos do Firebase:", error);
                loadingNewOrders.innerText = 'Erro ao carregar pedidos.';
                loadingAcceptedOrders.innerText = ''; // Limpa se houver erro
                loadingCompletedOrders.innerText = ''; // Limpa se houver erro
                showToast('Erro ao carregar pedidos.');
            });

            updateDateTime(); // Atualiza a data e hora ao carregar
            setInterval(updateDateTime, 60000); // Atualiza a cada minuto
        });
    </script>
</body>
</html>
